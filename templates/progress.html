<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing - Subtitle Generator</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .progress-steps {
            padding: 0;
            list-style: none;
        }
        .step {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--bs-border-color);
        }
        .step:last-child {
            border-bottom: none;
        }
        .step-icon {
            width: 40px;
            text-align: center;
            margin-right: 15px;
            font-size: 1.2em;
            color: var(--bs-secondary);
        }
        .step-text {
            flex: 1;
        }
        .step-status {
            width: 30px;
            text-align: center;
        }
        .step.active .step-icon {
            color: var(--bs-primary);
        }
        .step.completed .step-icon {
            color: var(--bs-success);
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <i class="fas fa-cogs fa-3x text-primary mb-3"></i>
                    <h1 class="display-4 mb-3">Processing Your File</h1>
                    <p class="lead text-muted">{{ filename }} - Please wait while we transcribe and translate your media</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tasks me-2"></i>Processing Progress
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Overall Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span id="progressText">Preparing processing...</span>
                                <span id="progressPercentage">0%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                     0%
                                </div>
                            </div>
                        </div>

                        <!-- Processing Steps -->
                        <div class="progress-steps">
                            <div class="step" id="step-starting">
                                <i class="fas fa-play-circle step-icon"></i>
                                <span class="step-text">Initializing transcription...</span>
                                <div class="step-status">
                                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                                    <i class="fas fa-check text-success d-none"></i>
                                </div>
                            </div>
                            <div class="step" id="step-transcription">
                                <i class="fas fa-microphone step-icon"></i>
                                <span class="step-text">Transcribing speech to text...</span>
                                <div class="step-status">
                                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                                    <i class="fas fa-check text-success d-none"></i>
                                </div>
                            </div>
                            <div class="step" id="step-subtitle_generation">
                                <i class="fas fa-file-alt step-icon"></i>
                                <span class="step-text">Generating subtitle files...</span>
                                <div class="step-status">
                                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                                    <i class="fas fa-check text-success d-none"></i>
                                </div>
                            </div>
                            <div class="step" id="step-translation">
                                <i class="fas fa-language step-icon"></i>
                                <span class="step-text">Translating to selected languages...</span>
                                <div class="step-status">
                                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                                    <i class="fas fa-check text-success d-none"></i>
                                </div>
                            </div>
                            <div class="step" id="step-completed">
                                <i class="fas fa-flag-checkered step-icon"></i>
                                <span class="step-text">Processing completed!</span>
                                <div class="step-status">
                                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                                    <i class="fas fa-check text-success d-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Current Activity -->
                        <div class="mt-4">
                            <div class="alert alert-info" id="statusAlert">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="statusText">Connecting to processing server...</span>
                            </div>
                        </div>

                        <!-- Error Display -->
                        <div class="alert alert-danger d-none" id="errorAlert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                            <div class="mt-2">
                                <button id="retryBtn" class="btn btn-sm btn-outline-light" onclick="startProcessing()">
                                    <i class="fas fa-redo me-1"></i>Retry
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Upload
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Processing Stats -->
                <div class="row mt-4">
                    <div class="col-md-4 text-center">
                        <div class="card border-0 bg-transparent">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-info mb-3"></i>
                                <h6>Est. Processing Time</h6>
                                <p class="text-muted small">2-5 minutes for typical files</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="card border-0 bg-transparent">
                            <div class="card-body">
                                <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                                <h6>Privacy Protected</h6>
                                <p class="text-muted small">Files auto-deleted after 24 hours</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="card border-0 bg-transparent">
                            <div class="card-body">
                                <i class="fas fa-download fa-2x text-warning mb-3"></i>
                                <h6>Multiple Formats</h6>
                                <p class="text-muted small">SRT, VTT, and ASS subtitle files</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io();
        const sessionId = '{{ session_id }}';
        
        // Progress elements
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercentage = document.getElementById('progressPercentage');
        const statusAlert = document.getElementById('statusAlert');
        const statusText = document.getElementById('statusText');
        const errorAlert = document.getElementById('errorAlert');
        const errorText = document.getElementById('errorText');

        let currentStage = '';
        let processingStarted = false;

        // Update progress bar
        function updateProgress(percentage, text) {
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressPercentage.textContent = percentage + '%';
            if (text) {
                progressText.textContent = text;
            }
        }

        // Update step status
        function updateStep(stepId, status) {
            const step = document.getElementById('step-' + stepId);
            if (!step) return;

            const spinner = step.querySelector('.spinner-border');
            const checkIcon = step.querySelector('.fa-check');

            // Reset all status indicators
            spinner.classList.add('d-none');
            checkIcon.classList.add('d-none');
            step.classList.remove('active', 'completed');

            if (status === 'active') {
                step.classList.add('active');
                spinner.classList.remove('d-none');
            } else if (status === 'completed') {
                step.classList.add('completed');
                checkIcon.classList.remove('d-none');
            }
        }

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            statusText.textContent = 'Connected to server. Starting processing...';
            socket.emit('join_session', { session_id: sessionId });
            
            if (!processingStarted) {
                startProcessing();
            }
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            statusText.textContent = 'Connection lost. Trying to reconnect...';
        });

        socket.on('progress_update', function(data) {
            console.log('Progress update:', data);
            
            currentStage = data.stage;
            const percentage = data.progress || 0;
            const message = data.message || '';

            updateProgress(percentage, message);
            statusText.textContent = message;

            // Update step status
            if (data.stage === 'transcription') {
                updateStep('starting', 'completed');
                updateStep('transcription', percentage < 100 ? 'active' : 'completed');
            } else if (data.stage === 'subtitle_generation') {
                updateStep('transcription', 'completed');
                updateStep('subtitle_generation', percentage < 100 ? 'active' : 'completed');
            } else if (data.stage === 'translation') {
                updateStep('subtitle_generation', 'completed');
                updateStep('translation', percentage < 100 ? 'active' : 'completed');
            }
        });

        socket.on('processing_complete', function(data) {
            console.log('Processing complete:', data);
            
            updateProgress(100, 'Processing completed successfully!');
            updateStep('translation', 'completed');
            updateStep('completed', 'completed');
            
            statusAlert.className = 'alert alert-success';
            statusText.innerHTML = '<i class="fas fa-check me-2"></i>Processing completed! Redirecting to results...';

            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 2000);
        });

        socket.on('processing_error', function(data) {
            console.error('Processing error:', data);
            
            errorText.textContent = data.error || 'An error occurred during processing';
            errorAlert.classList.remove('d-none');
            statusAlert.classList.add('d-none');
            
            // Stop progress animation
            progressBar.classList.remove('progress-bar-animated');
        });

        // Start processing
        function startProcessing() {
            if (processingStarted) return;
            
            processingStarted = true;
            updateStep('starting', 'active');
            statusText.textContent = 'Initializing processing...';

            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_language: '{{ request.form.get("source_language", "auto") }}',
                    target_languages: {{ target_languages | tojson if target_languages else '["en"]' | safe }},
                    formats: ['srt', 'vtt', 'ass']
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Failed to start processing');
                }
                console.log('Processing started successfully');
            })
            .catch(error => {
                console.error('Failed to start processing:', error);
                errorText.textContent = 'Failed to start processing: ' + error.message;
                errorAlert.classList.remove('d-none');
                statusAlert.classList.add('d-none');
            });
        }

        // Auto-start processing when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (socket.connected && !processingStarted) {
                    startProcessing();
                }
            }, 1000);
        });
    </script>
</body>
</html>